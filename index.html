<!DOCTYPE html>
<html>
<head>
    <title>MTR到站時間查詢</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <style>
        /* MTR風格 */
        :root {
            --mtr-red: #b01c2e;  /* MTR紅色 */
            --mtr-blue: #0075c2;
            --mtr-gray: #888b8d;
            --mtr-light-gray: #f2f2f2;
            --mtr-dark-gray: #333;
            --app-background: linear-gradient(135deg, #e0e0e0 0%, #f0f0f0 100%); /* 更柔和的背景 */
            --card-shadow: 0 6px 20px rgba(0,0,0,0.1); /* 更明顯的卡片陰影 */
            --button-shadow: 0 4px 12px rgba(0,117,194,0.3); /* 按鈕陰影 */
            --border-radius-lg: 18px; /* 大圓角 */
            --border-radius-md: 12px; /* 中圓角 */
            --border-radius-sm: 8px; /* 小圓角 */
        }
        
        body {
            font-family: 'Inter', Arial, "Microsoft JhengHei", "微軟正黑體", sans-serif;
            background: var(--app-background);
            margin: 0;
            padding: 0;
            color: var(--mtr-dark-gray);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* 將內容從頂部開始排列 */
            overflow-x: hidden; /* 防止水平滾動 */
            padding-bottom: 20px; /* 底部留白，模擬App底部導航欄的空間 */
            box-sizing: border-box; /* 確保padding不會增加總寬度 */
        }

        /* 針對iOS安全區域的額外填充 */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .header {
            background: linear-gradient(135deg, var(--mtr-red) 0%, #d01829 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-bottom-left-radius: var(--border-radius-lg);
            border-bottom-right-radius: var(--border-radius-lg);
            position: sticky; /* 讓Header在滾動時固定在頂部 */
            top: 0;
            width: 100%;
            z-index: 100;
            overflow: hidden;
            padding-top: calc(20px + env(safe-area-inset-top)); /* 考慮安全區 */
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
            50% { transform: translateX(0%) translateY(0%) rotate(180deg); }
        }
        
        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .mtr-logo {
            font-size: 2.5rem;
            margin-right: 15px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .container {
            max-width: 550px;
            width: calc(100% - 30px); /* 兩邊各15px的邊距 */
            margin: 20px auto; /* 調整上邊距 */
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            backdrop-filter: blur(10px);
            flex-grow: 1; /* 讓容器佔據剩餘空間 */
        }
        
        .search-box {
            padding: 25px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
        }
        
        .input-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--mtr-gray);
            border-radius: var(--border-radius-md);
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: white;
            -webkit-appearance: none; /* 移除iOS上的默認樣式 */
        }
        
        input:focus {
            border-color: var(--mtr-blue);
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 117, 194, 0.2);
            transform: translateY(-2px);
        }
        
        input:hover {
            border-color: var(--mtr-blue);
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--mtr-blue) 0%, #005a9c 100%);
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: var(--button-shadow);
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent; /* 移除點擊高亮 */
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            background: linear-gradient(135deg, #005a9c 0%, var(--mtr-blue) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,117,194,0.4);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0,117,194,0.3);
        }
        
        .result {
            padding: 0;
            display: none;
        }
        
        .station-header {
            background: linear-gradient(135deg, var(--mtr-blue) 0%, #005a9c 100%);
            color: white;
            padding: 20px 25px;
            font-size: 1.4rem;
            font-weight: bold;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255,255,255,0.2); /* 讓header底部有分隔線 */
        }
        
        .station-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="70" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
        }
        
        .station-en {
            color: rgba(255,255,255,0.9);
            font-size: 0.9em;
            font-weight: normal;
            margin-top: 8px;
        }
        
        .line-section {
            margin: 0;
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #ffffff 0%, #fcfcfc 100%);
        }
        
        .line-badge {
            display: flex; /* 使用flexbox對齊 */
            align-items: center;
            justify-content: space-between; /* 將徽章和按鈕分開 */
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            width: fit-content; /* 讓徽章寬度適應內容 */
            /* Removed background from here, it will be set by JS dynamically */
        }
        
        .line-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: badge-shimmer 2s infinite;
        }
        
        @keyframes badge-shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* New styles for grouped display */
        .direction-destination-platform-group {
            background: linear-gradient(135deg, #ffffff 0%, #fcfcfc 100%); /* Changed to white background for the group */
            margin: 15px 0; /* Add margin between groups */
            padding: 15px 20px; /* Padding for the group card */
            border-radius: var(--border-radius-md); /* Rounded corners for the group card */
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Lighter shadow for group cards */
            border: 1px solid #eee; /* Light border */
        }

        .group-header {
            font-weight: bold;
            font-size: 1.1rem; /* Slightly larger font for header */
            color: var(--mtr-dark-gray);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Space for refresh button */
        }

        /* 新增：用於包裹方向、目的地和月台資訊的容器 */
        .group-title-content {
            display: flex; /* 使用flexbox控制內部元素排版 */
            flex-wrap: wrap; /* 允許換行 */
            align-items: baseline; /* 讓文字基線對齊 */
            flex-grow: 1; /* 允許其佔據可用空間 */
            margin-right: 10px; /* 與刷新按鈕之間留點空間 */
        }

        /* 新增：方向和目的地的文字樣式 */
        .direction-destination-text {
            /* 繼承 group-header 的字體大小 */
            margin-right: 5px; /* 在月台資訊之前留點小空間 */
            white-space: nowrap; /* 盡量保持方向和目的地在同一行 */
        }

        /* 新增：月台資訊的樣式 */
        .platform-info {
            font-size: 0.9em; /* 比主文字稍小 */
            color: var(--mtr-gray); /* 更柔和的顏色 */
            font-weight: normal; /* 不如主文字粗體 */
            white-space: nowrap; /* 盡量保持月台資訊在同一行 */
        }

        /* 針對小屏幕的響應式調整 */
        @media (max-width: 450px) {
            .group-title-content {
                flex-direction: column; /* 在小屏幕上將方向/目的地和月台資訊堆疊顯示 */
                align-items: flex-start;
            }
            .direction-destination-text {
                margin-right: 0;
                margin-bottom: 5px; /* 堆疊時，在兩行之間留點空間 */
            }
            .platform-info {
                font-size: 1rem; /* 堆疊時，調整字體大小 */
            }
        }

        .group-header .refresh-btn {
            margin-left: auto; /* Push refresh button to the right */
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 15px;
        }

        .times-list {
            display: flex;
            flex-wrap: wrap; /* Allow times to wrap to next line */
            gap: 10px; /* Space between time items */
            justify-content: flex-start; /* Align items to the start */
        }

        .time-item {
            font-weight: bold;
            color: var(--mtr-red);
            font-size: 18px; /* Slightly smaller for multiple items */
            background: linear-gradient(135deg, white 0%, #f9f9f9 100%);
            padding: 6px 12px; /* Smaller padding */
            border-radius: var(--border-radius-sm);
            box-shadow: 0 1px 5px rgba(0,0,0,0.08); /* Lighter shadow */
            border: 1px solid var(--mtr-red); /* Thinner border */
            animation: none; /* Remove pulse animation from individual times */
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        .time-item.missed {
            color: #d9534f;
            font-size: 16px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #ffe0e0 0%, #ffcccc 100%);
            border: 1px solid #d9534f;
            animation: missed-shake 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes missed-shake {
            0% { transform: translateX(-2px); }
            100% { transform: translateX(2px); }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--mtr-gray);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0,0,0,0.1);
            border-left-color: var(--mtr-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .suggestions {
            background: white;
            border: 2px solid #ddd;
            border-radius: var(--border-radius-md);
            max-height: 250px;
            overflow-y: auto;
            position: absolute;
            width: calc(100% - 40px); /* 考慮到輸入框的padding */
            max-width: 550px;
            z-index: 20;
            display: none;
            box-shadow: var(--card-shadow);
            top: 100%;
            left: 0;
            margin-top: 5px;
        }
        
        .suggestion-item {
            padding: 12px 18px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item:hover, .suggestion-item.selected { /* 添加selected樣式 */
            background: linear-gradient(135deg, var(--mtr-light-gray) 0%, #e8e8e8 100%);
            transform: translateX(5px);
        }
        
        .error {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            padding: 18px;
            margin: 18px 25px;
            border-radius: var(--border-radius-md);
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(255,193,7,0.2);
        }
        
        .footer {
            padding: 18px;
            text-align: center;
            color: var(--mtr-gray);
            font-size: 12px;
            border-top: 1px solid #eee;
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            width: 100%; /* 讓footer佔滿寬度 */
            box-sizing: border-box;
        }
        
        /* The individual refresh button moved inside .group-header */
        .refresh-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 6px 12px; /* 更小的padding */
            border-radius: 20px; /* 更圓的按鈕 */
            font-size: 12px; /* 更小的字體 */
            margin-left: 10px; /* Space from badge */
            box-shadow: 0 2px 6px rgba(40,167,69,0.2); /* 更輕的陰影 */
            width: auto; /* Auto width */
            display: inline-flex; /* Make it inline-flex for spinner alignment */
            align-items: center; /* Align items vertically */
            vertical-align: middle; /* Align with text */
            white-space: nowrap; /* 防止文字換行 */
            border: none; /* Remove default button border */
            color: white; /* Ensure text color is white */
            cursor: pointer; /* Indicate it's clickable */
            transition: all 0.3s ease; /* Smooth transitions */
        }
        
        .refresh-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1c7a5a 100%);
            box-shadow: 0 3px 9px rgba(40,167,69,0.3); /* Slightly larger shadow on hover */
            transform: translateY(-1px); /* Slight lift on hover */
        }

        .refresh-btn:active {
            transform: translateY(0); /* Press effect */
            box-shadow: 0 1px 3px rgba(40,167,69,0.2);
        }

        .refresh-btn .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.5);
            border-left-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 5px;
        }
        
        .direction-header {
            /* This style is now largely replaced by .group-header */
            background: linear-gradient(135deg, var(--mtr-light-gray) 0%, #e8e8e8 100%);
            padding: 10px 18px;
            margin: 18px 0 12px;
            border-radius: var(--border-radius-sm);
            font-weight: bold;
            color: #333;
            border-left: 4px solid var(--mtr-blue);
        }
        
        .emoji {
            margin-right: 8px;
        }
        
        .recent-stations {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .recent-title {
            font-size: 14px;
            color: var(--mtr-gray);
            margin-bottom: 12px;
            font-weight: 600;
            display: flex; /* Use flexbox for title and clear button */
            justify-content: space-between; /* Space them out */
            align-items: center;
        }

        .clear-recent-btn {
            background: none;
            border: none;
            color: var(--mtr-gray);
            font-size: 12px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.3s ease;
            width: auto; /* Override button default width */
            text-align: right;
            box-shadow: none; /* Remove button shadow */
        }

        .clear-recent-btn:hover {
            color: var(--mtr-red);
            background: var(--mtr-light-gray);
            transform: translateY(-1px);
        }
        
        .recent-item {
            display: inline-block;
            background: linear-gradient(135deg, var(--mtr-light-gray) 0%, #e8e8e8 100%);
            padding: 10px 16px;
            margin: 0 8px 8px 0;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .recent-item:hover {
            background: linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%);
            transform: translateY(-2px);
            border-color: var(--mtr-blue);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Custom Message Box Styles */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* 更深的背景 */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(8px); /* 更強的模糊效果 */
        }

        .message-box-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .message-box-content {
            background: linear-gradient(135deg, white 0%, #f9f9f9 100%);
            padding: 35px;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4); /* 更大的陰影 */
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* 彈性動畫 */
        }

        .message-box-overlay.show .message-box-content {
            transform: scale(1);
        }

        .message-box-content h3 {
            margin-top: 0;
            color: var(--mtr-red);
            font-size: 1.6rem;
            margin-bottom: 18px;
        }

        .message-box-content p {
            margin-bottom: 28px;
            font-size: 1.1rem;
            color: var(--mtr-dark-gray);
            line-height: 1.6;
        }

        .message-box-content button {
            background: linear-gradient(135deg, var(--mtr-blue) 0%, #005a9c 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            width: auto;
        }

        .message-box-content button:hover {
            background: linear-gradient(135deg, #005a9c 0%, var(--mtr-blue) 100%);
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                margin: 15px;
                border-radius: var(--border-radius-lg);
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .mtr-logo {
                font-size: 2rem;
            }
            
            .search-box {
                padding: 20px;
            }
            
            input {
                padding: 12px 15px;
                font-size: 16px;
            }
            
            button {
                padding: 12px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <div class="mtr-logo">🚇</div>
            MTR到站時間查詢
        </h1>
    </div>
    
    <div class="container">
        <div class="search-box">
            <div class="input-container">
                <input 
                    type="text" 
                    id="stationInput" 
                    placeholder="🔍 輸入車站名稱 (例如: 金鐘, Admiralty)" 
                    oninput="showSuggestions()"
                >
                <div id="suggestions" class="suggestions"></div>
            </div>
            <button onclick="searchStation()">🚆 查詢到站時間</button>
            
            <div id="recentStations" class="recent-stations">
                <div class="recent-title">
                    📍 最近搜尋
                    <button class="clear-recent-btn" onclick="clearRecentStations()">清空</button>
                </div>
                <div id="recentList"></div>
            </div>
        </div>
        
        <div id="result" class="result"></div>
    </div>

    <!-- Custom Message Box HTML -->
    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box-content">
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxText"></p>
            <button onclick="hideMessage()">確認</button>
        </div>
    </div>

    <script>
        // 車站資料 (中英文)
        const stations = {
            '金鐘': { code: 'ADM', en: 'Admiralty', lines: ['TWL', 'ISL', 'SIL', 'EAL'] },
            '中環': { code: 'CEN', en: 'Central', lines: ['TWL', 'ISL'] },
            '尖沙咀': { code: 'TST', en: 'Tsim Sha Tsui', lines: ['TWL'] },
            '旺角': { code: 'MOK', en: 'Mong Kok', lines: ['TWL', 'KTL'] },
            '油麻地': { code: 'YMT', en: 'Yau Ma Tei', lines: ['TWL', 'KTL'] },
            '九龍塘': { code: 'KOT', en: 'Kowloon Tong', lines: ['KTL', 'EAL'] },
            '油塘': { code: 'YAT', en: 'Yau Tong', lines: ['KTL', 'TKL'] },
            '調景嶺': { code: 'TIK', en: 'Tiu Keng Leng', lines: ['KTL', 'TKL'] },
            '北角': { code: 'NOP', en: 'North Point', lines: ['ISL', 'TKL'] },
            '鰂魚涌': { code: 'QUB', en: 'Quarry Bay', lines: ['ISL', 'TKL'] },
            '大圍': { code: 'TAW', en: 'Tai Wai', lines: ['EAL', 'TML'] },
            '沙田': { code: 'SHT', en: 'Sha Tin', lines: ['EAL'] },
            '荃灣': { code: 'TSW', en: 'Tsuen Wan', lines: ['TWL'] },
            '東涌': { code: 'TUC', en: 'Tung Chung', lines: ['TCL'] },
            '香港': { code: 'HOK', en: 'Hong Kong', lines: ['TCL', 'AEL'] },
            '九龍': { code: 'KOW', en: 'Kowloon', lines: ['TCL', 'AEL'] },
            '會展': { code: 'EXC', en: 'Exhibition Centre', lines: ['EAL'] },
            '紅磡': { code: 'HUH', en: 'Hung Hom', lines: ['EAL', 'TML'] },
            '鑽石山': { code: 'DIH', en: 'Diamond Hill', lines: ['KTL', 'TML'] },
            '美孚': { code: 'MEF', en: 'Mei Foo', lines: ['TWL', 'TML'] },
            '太子': { code: 'PRE', en: 'Prince Edward', lines: ['TWL', 'KTL'] },
            '銅鑼灣': { code: 'CAB', en: 'Causeway Bay', lines: ['ISL'] },
            '灣仔': { code: 'WAC', en: 'Wan Chai', lines: ['ISL'] },
            '柴灣': { code: 'CHW', en: 'Chai Wan', lines: ['ISL'] },
            '黃埔': { code: 'WHA', en: 'Whampoa', lines: ['KTL'] },
            '觀塘': { code: 'KWT', en: 'Kwun Tong', lines: ['KTL'] },
            '九龍灣': { code: 'KOB', en: 'Kowloon Bay', lines: ['KTL'] },
            '將軍澳': { code: 'TKO', en: 'Tseung Kwan O', lines: ['TKL'] },
            '寶琳': { code: 'POA', en: 'Po Lam', lines: ['TKL'] },
            '康城': { code: 'LOH', en: 'LOHAS Park', lines: ['TKL'] },
            '上水': { code: 'SHS', en: 'Sheung Shui', lines: ['EAL'] },
            '羅湖': { code: 'LOW', en: 'Lo Wu', lines: ['EAL'] },
            '落馬洲': { code: 'LMC', en: 'Lok Ma Chau', lines: ['EAL'] },
            '烏溪沙': { code: 'WKS', en: 'Wu Kai Sha', lines: ['TML'] },
            '屯門': { code: 'TUM', en: 'Tuen Mun', lines: ['TML'] },
            '青衣': { code: 'TSY', en: 'Tsing Yi', lines: ['TCL', 'AEL'] },
            '機場': { code: 'AIR', en: 'Airport', lines: ['AEL'] },
            '海怡半島': { code: 'SOH', en: 'South Horizons', lines: ['SIL'] },
            '海洋公園': { code: 'OCP', en: 'Ocean Park', lines: ['SIL'] },
            '黃竹坑': { code: 'WCH', en: 'Wong Chuk Hang', lines: ['SIL'] },
            '利東': { code: 'LET', en: 'Lei Tung', lines: ['SIL'] },
            '迪士尼': { code: 'DIS', en: 'Disneyland Resort', lines: ['DRL'] },
            '欣澳': { code: 'SUN', en: 'Sunny Bay', lines: ['TCL', 'DRL'] },
            // 新增的車站
            '香港大學': { code: 'HKU', en: 'HKU', lines: ['ISL'] },
            '西營盤': { code: 'SYP', en: 'Sai Ying Pun', lines: ['ISL'] },
            '上環': { code: 'SHW', en: 'Sheung Wan', lines: ['ISL'] },
            '天后': { code: 'TIH', en: 'Tin Hau', lines: ['ISL'] },
            '炮台山': { code: 'FOH', en: 'Fortress Hill', lines: ['ISL'] },
            '太古': { code: 'TAK', en: 'Tai Koo', lines: ['ISL'] },
            '西灣河': { code: 'SWN', en: 'Sai Wan Ho', lines: ['ISL'] },
            '筲箕灣': { code: 'SKW', en: 'Shau Kei Wan', lines: ['ISL'] },
            '杏花邨': { code: 'HFC', en: 'Heng Fa Chuen', lines: ['ISL'] },
            '何文田': { code: 'HOM', en: 'Ho Man Tin', lines: ['KTL', 'TML'] },
            '石硤尾': { code: 'SKM', en: 'Shek Kip Mei', lines: ['KTL'] },
            '樂富': { code: 'LOF', en: 'Lok Fu', lines: ['KTL'] },
            '黃大仙': { code: 'WTS', en: 'Wong Tai Sin', lines: ['KTL'] },
            '彩虹': { code: 'CHH', en: 'Choi Hung', lines: ['KTL'] },
            '牛頭角': { code: 'NTK', en: 'Ngau Tau Kok', lines: ['KTL'] },
            '藍田': { code: 'LAT', en: 'Lam Tin', lines: ['KTL'] },
            '佐敦': { code: 'JOR', en: 'Jordan', lines: ['TWL'] },
            '深水埗': { code: 'SSP', en: 'Sham Shui Po', lines: ['TWL'] },
            '長沙灣': { code: 'CSW', en: 'Cheung Sha Wan', lines: ['TWL'] },
            '荔枝角': { code: 'LCK', en: 'Lai Chi Kok', lines: ['TWL'] },
            '荔景': { code: 'LAK', en: 'Lai King', lines: ['TWL', 'TCL'] },
            '葵芳': { code: 'KWF', en: 'Kwai Fong', lines: ['TWL'] },
            '葵興': { code: 'KWH', en: 'Kwai Hing', lines: ['TWL'] },
            '大窩口': { code: 'TWH', en: 'Tai Wo Hau', lines: ['TWL'] },
            '坑口': { code: 'HAK', en: 'Hang Hau', lines: ['TKL'] },
            '旺角東': { code: 'MKE', en: 'Mong Kok East', lines: ['EAL'] },
            '火炭': { code: 'FOT', en: 'Fo Tan', lines: ['EAL'] },
            '馬場': { code: 'RAC', en: 'Racecourse', lines: ['EAL'] },
            '大學': { code: 'UNI', en: 'University', lines: ['EAL'] },
            '大埔墟': { code: 'TAP', en: 'Tai Po Market', lines: ['EAL'] },
            '太和': { code: 'TWO', en: 'Tai Wo', lines: ['EAL'] },
            '粉嶺': { code: 'FAN', en: 'Fanling', lines: ['EAL'] },
            '馬鞍山': { code: 'MOS', en: 'Ma On Shan', lines: ['TML'] },
            '恆安': { code: 'HEO', en: 'Heng On', lines: ['TML'] },
            '大水坑': { code: 'TSH', en: 'Tai Shui Hang', lines: ['TML'] },
            '石門': { code: 'SHM', en: 'Shek Mun', lines: ['TML'] },
            '第一城': { code: 'CIO', en: 'City One', lines: ['TML'] },
            '沙田圍': { code: 'STW', en: 'Sha Tin Wai', lines: ['TML'] },
            '車公廟': { code: 'CKT', en: 'Che Kung Temple', lines: ['TML'] },
            '顯徑': { code: 'HIK', en: 'Hin Keng', lines: ['TML'] },
            '啟德': { code: 'KAT', en: 'Kai Tak', lines: ['TML'] },
            '宋皇臺': { code: 'SWT', en: 'Sung Wong Toi', lines: ['TML'] },
            '土瓜灣': { code: 'TKW', en: 'To Kwa Wan', lines: ['TML'] },
            '尖東': { code: 'ETS', en: 'East Tsim Sha Tsui', lines: ['TML'] },
            '柯士甸': { code: 'AUS', en: 'Austin', lines: ['TML'] },
            '南昌': { code: 'NAC', en: 'Nam Cheong', lines: ['TCL', 'TML'] },
            '荃灣西': { code: 'TWW', en: 'Tsuen Wan West', lines: ['TML'] },
            '錦上路': { code: 'KSR', en: 'Kam Sheung Road', lines: ['TML'] },
            '元朗': { code: 'YUL', en: 'Yuen Long', lines: ['TML'] },
            '朗屏': { code: 'LGP', en: 'Long Ping', lines: ['TML'] },
            '奧運': { code: 'OLY', en: 'Olympic', lines: ['TCL'] },
            '博覽館': { code: 'AWE', en: 'AsiaWorld-Expo', lines: ['AEL'] }
        };
        
        // 線路對應的emoji
        const lineEmojis = {
            'TWL': '🔴', // 荃灣線
            'ISL': '🔵', // 港島線
            'KTL': '🟢', // 觀塘線
            'TKL': '🟣', // 將軍澳線
            'EAL': '🔷', // 東鐵線
            'TML': '🟤', // 屯馬線
            'TCL': '🟠', // 東涌線
            'AEL': '🟦', // 機場快綫
            'SIL': '🟡', // 南港島線
            'DRL': '🟪'  // 迪士尼線
        };
        
        // 建立英文到中文的映射
        const enToZh = {};
        for (const [zh, data] of Object.entries(stations)) {
            enToZh[data.en.toLowerCase()] = zh;
        }
        
        // 線路資料
        const lines = {
            'TWL': { name: '荃灣線', color: '#E2231A' },
            'ISL': { name: '港島線', color: '#0860A8' },
            'KTL': { name: '觀塘線', color: '#7ED321' },
            'TKL': { name: '將軍澳線', color: '#7B91C6' },
            'EAL': { name: '東鐵線', color: '#5EB3F5' },
            'TML': { name: '屯馬線', color: '#8D6019' },
            'TCL': { name: '東涌線', color: '#F7931D' },
            'AEL': { name: '機場快綫', color: '#1C7670' },
            'SIL': { name: '南港島線', color: '#CBCD09' },
            'DRL': { name: '迪士尼線', color: '#F550A6' }
        };
        
        /**
         * Displays a custom message box instead of using alert().
         * @param {string} title - The title of the message box.
         * @param {string} message - The message to display.
         */
        function showMessage(title, message) {
            document.getElementById('messageBoxTitle').textContent = title;
            document.getElementById('messageBoxText').textContent = message;
            document.getElementById('messageBoxOverlay').classList.add('show');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessage() {
            document.getElementById('messageBoxOverlay').classList.remove('show');
        }

        /**
         * Loads and displays recent stations from local storage.
         */
        function loadRecentStations() {
            const recentStations = JSON.parse(localStorage.getItem('recentStations') || '[]');
            const recentList = document.getElementById('recentList');
            const recentStationsContainer = document.getElementById('recentStations');
            
            if (recentStations.length === 0) {
                recentStationsContainer.style.display = 'none';
                return;
            }
            
            recentStationsContainer.style.display = 'block';
            recentList.innerHTML = '';
            
            recentStations.forEach(station => {
                const item = document.createElement('span');
                item.className = 'recent-item';
                item.textContent = station;
                item.onclick = () => {
                    document.getElementById('stationInput').value = station;
                    searchStation();
                };
                recentList.appendChild(item);
            });
        }
        
        /**
         * Saves a station name to recent searches in local storage.
         * @param {string} stationName - The name of the station to save.
         */
        function saveRecentStation(stationName) {
            let recentStations = JSON.parse(localStorage.getItem('recentStations') || '[]');
            
            // 如果已經存在，先移除舊的
            recentStations = recentStations.filter(s => s !== stationName);
            
            // 添加到最前面
            recentStations.unshift(stationName);
            
            // 只保留最近5個
            if (recentStations.length > 5) {
                recentStations = recentStations.slice(0, 5);
            }
            
            localStorage.setItem('recentStations', JSON.stringify(recentStations));
            loadRecentStations();
        }

        /**
         * Clears all recent stations from local storage.
         */
        function clearRecentStations() {
            localStorage.removeItem('recentStations');
            loadRecentStations(); // Re-render to show empty state
            showMessage('已清空', '最近搜尋記錄已全部清除。');
        }
        
        // 顯示建議的timeout ID
        let suggestionTimeout;
        /**
         * Shows station suggestions based on user input.
         */
        function showSuggestions() {
            clearTimeout(suggestionTimeout);
            suggestionTimeout = setTimeout(() => {
                const input = document.getElementById('stationInput').value.trim().toLowerCase();
                const suggestionsDiv = document.getElementById('suggestions');
                
                if (input.length < 1) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                // 搜尋中文和英文名稱
                const matchedStations = [];
                
                // 搜尋中文名稱
                Object.keys(stations).forEach(zh => {
                    if (zh.toLowerCase().includes(input)) {
                        matchedStations.push({ zh, en: stations[zh].en });
                    }
                });
                
                // 搜尋英文名稱
                Object.keys(enToZh).forEach(en => {
                    if (en.includes(input) && !matchedStations.some(s => s.zh === enToZh[en])) {
                        matchedStations.push({ zh: enToZh[en], en: stations[enToZh[en]].en });
                    }
                });
                
                if (matchedStations.length > 0) {
                    let html = '';
                    matchedStations.slice(0, 8).forEach(station => {
                        html += `
                            <div class="suggestion-item" onclick="selectStation('${station.zh}')">
                                🚉 ${station.zh} <span class="station-en">(${station.en})</span>
                            </div>
                        `;
                    });
                    
                    suggestionsDiv.innerHTML = html;
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            }, 200); // Debounce time
        }
        
        /**
         * Selects a station from suggestions and triggers a search.
         * @param {string} station - The name of the selected station.
         */
        function selectStation(station) {
            document.getElementById('stationInput').value = station;
            document.getElementById('suggestions').style.display = 'none';
            searchStation();
        }
        
        // 儲存當前查詢的車站資訊，以便單獨重新整理
        let currentStationData = null;

        /**
         * Initiates the search for MTR arrival times for the entered station.
         */
        async function searchStation() {
            let stationName = document.getElementById('stationInput').value.trim();
            
            if (!stationName) {
                showMessage('輸入錯誤', '請輸入車站名稱');
                return;
            }
            
            // 檢查是否是英文名稱
            const lowerInput = stationName.toLowerCase();
            if (enToZh[lowerInput]) {
                stationName = enToZh[lowerInput];
            }
            
            const station = stations[stationName];
            if (!station) {
                document.getElementById('result').style.display = 'block';
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        ⚠️ 搵唔到「${stationName}」呢個站喎，麻煩你睇吓係咪打錯字？
                        <br>例如：金鐘(Admiralty)、中環(Central)、旺角(Mong Kok)都得㗎。
                    </div>
                `;
                return;
            }
            
            // 保存到最近搜尋
            saveRecentStation(stationName);
            
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>⏳ 努力幫你搵緊到站時間...</div>
                </div>
            `;
            
            // Store current station data globally for individual line refresh
            currentStationData = {
                name: stationName,
                code: station.code,
                en: station.en,
                lines: station.lines
            };

            try {
                // Fetch data for all lines concurrently
                const promises = station.lines.map(line => 
                    fetch(`https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line=${line}&sta=${station.code}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => ({ line, data }))
                        .catch(error => ({ line, error }))
                );
                
                const results = await Promise.all(promises);
                displayAllLines(results, stationName, station);
                
            } catch (error) {
                console.error('Error fetching MTR data:', error);
                result.innerHTML = '<div class="error">❌ 唔好意思，好似有啲問題，請檢查下你個網絡或者遲啲再試過啦。</div>';
            }
        }

        /**
         * Formats the arrival time into a displayable HTML string.
         * @param {number} ttnt - Time to next train in minutes.
         * @returns {string} HTML string for the time item.
         */
        function formatArrivalTime(ttnt) {
            const displayTime = (ttnt === 0 || ttnt === 1) ? "趕唔切啦 😭😭" : `${ttnt} 分鐘`;
            const timeClass = (ttnt === 0 || ttnt === 1) ? "time-item missed" : "time-item";
            return `<div class="${timeClass}">⏱️ ${displayTime}</div>`;
        }

        /**
         * Refreshes data for a specific line and a specific direction/destination/platform group.
         * @param {string} lineCode - The MTR line code (e.g., 'TWL').
         * @param {string} stationCode - The MTR station code (e.g., 'ADM').
         * @param {string} direction - 'UP' or 'DOWN'.
         * @param {string} destinationCode - The destination station code.
         * @param {string} platform - The platform number.
         */
        async function refreshGroup(lineCode, stationCode, direction, destinationCode, platform) {
            const groupId = `group-${lineCode}-${direction}-${destinationCode}-${platform}`;
            const targetGroup = document.getElementById(groupId);
            const refreshButton = targetGroup.querySelector('.refresh-btn');
            const originalButtonText = refreshButton.innerHTML;

            if (!targetGroup) {
                console.error(`Error: Group with ID ${groupId} not found.`);
                return;
            }

            // Show loading spinner on the button
            refreshButton.disabled = true;
            refreshButton.innerHTML = '<span class="spinner"></span> 更新中...';

            try {
                const response = await fetch(`https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line=${lineCode}&sta=${stationCode}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                let groupHtml = `
                    <div class="group-header">
                        <div class="group-title-content">
                            <span class="direction-destination-text">
                                ${direction === 'UP' ? '⬆️ 上行' : '⬇️ 下行'}往 ${getDestinationName(destinationCode)}
                            </span>
                            <span class="platform-info">月台${platform}</span>
                        </div>
                        <button class="refresh-btn" onclick="refreshGroup('${lineCode}', '${stationCode}', '${direction}', '${destinationCode}', '${platform}')">
                            🔄 重新整理
                        </button>
                    </div>
                    <div class="times-list">
                `;

                if (data.status === 1) {
                    const stationData = data.data[`${lineCode}-${stationCode}`];
                    if (stationData && stationData[direction]) {
                        const filteredTrains = stationData[direction].filter(train => 
                            train.dest === destinationCode && train.plat === platform
                        );
                        if (filteredTrains.length > 0) {
                            filteredTrains.sort((a, b) => a.ttnt - b.ttnt).forEach(train => {
                                groupHtml += formatArrivalTime(train.ttnt);
                            });
                        } else {
                            groupHtml += `<div class="time-item">📭 暫時未有列車資訊</div>`;
                        }
                    } else {
                        groupHtml += `<div class="time-item error-small">❌ 攞唔到數據</div>`;
                    }
                } else {
                    groupHtml += `<div class="time-item error-small">❌ 服務暫時用唔到</div>`;
                }
                groupHtml += `</div>`; // Close times-list
                targetGroup.innerHTML = groupHtml;

            } catch (error) {
                console.error(`Error refreshing group ${groupId} data:`, error);
                targetGroup.innerHTML = `
                    <div class="group-header">
                        <div class="group-title-content">
                            <span class="direction-destination-text">
                                ${direction === 'UP' ? '⬆️ 上行' : '⬇️ 下行'}往 ${getDestinationName(destinationCode)}
                            </span>
                            <span class="platform-info">月台${platform}</span>
                        </div>
                        <button class="refresh-btn" onclick="refreshGroup('${lineCode}', '${stationCode}', '${direction}', '${destinationCode}', '${platform}')">
                            🔄 重新整理
                        </button>
                    </div>
                    <div class="time-item error-small">❌ 刷新失敗，請檢查網絡。</div>
                `;
            } finally {
                // Restore button state - this part is handled by re-rendering the whole group,
                // but good practice to consider if only partial updates were done.
            }
            updateFooterTime(); // Update the overall last updated time
        }

        /**
         * Displays arrival times for all lines of a given station.
         * @param {Array<Object>} results - Array of fetch results for each line.
         * @param {string} stationName - Chinese name of the station.
         * @param {Object} station - Station data object.
         */
        function displayAllLines(results, stationName, station) {
            const result = document.getElementById('result');
            let html = `
                <div class="station-header">
                    🚉 ${stationName}
                    <div class="station-en">${station.en}</div>
                </div>
            `;
            
            results.forEach(({ line, data, error }) => {
                const lineSectionId = `line-section-${line}`;
                html += `<div class="line-section" id="${lineSectionId}">`;

                html += `
                    <div class="line-badge" style="background-color: ${lines[line].color}">
                        ${lineEmojis[line]} ${lines[line].name}
                    </div>
                `;

                if (error || data.status !== 1) {
                    html += `<div class="error">❌ 呢條線嘅數據攞唔到，或者服務暫時用唔到。</div>`;
                } else {
                    const stationData = data.data[`${line}-${station.code}`];
                    if (stationData) {
                        // Group trains by destination and platform for UP direction
                        const upGroups = {};
                        if (stationData.UP) {
                            stationData.UP.forEach(train => {
                                const key = `${train.dest}-${train.plat}`;
                                if (!upGroups[key]) {
                                    upGroups[key] = {
                                        dest: train.dest,
                                        plat: train.plat,
                                        times: []
                                    };
                                }
                                upGroups[key].times.push(train.ttnt);
                            });
                        }

                        // Render UP groups
                        if (Object.keys(upGroups).length > 0) {
                            for (const key in upGroups) {
                                const group = upGroups[key];
                                const groupId = `group-${line}-UP-${group.dest}-${group.plat}`;
                                html += `
                                    <div class="direction-destination-platform-group" id="${groupId}">
                                        <div class="group-header">
                                            <div class="group-title-content">
                                                <span class="direction-destination-text">
                                                    ⬆️ 上行往 ${getDestinationName(group.dest)}
                                                </span>
                                                <span class="platform-info">月台${group.plat}</span>
                                            </div>
                                            <button class="refresh-btn" onclick="refreshGroup('${line}', '${station.code}', 'UP', '${group.dest}', '${group.plat}')">
                                                🔄 重新整理
                                            </button>
                                        </div>
                                        <div class="times-list">
                                `;
                                group.times.sort((a, b) => a - b).forEach(ttnt => { // Sort times
                                    html += formatArrivalTime(ttnt);
                                });
                                html += `
                                        </div>
                                    </div>
                                `;
                            }
                        } else {
                            html += `<div class="direction-destination-platform-group"><div class="group-header"><div class="group-title-content">⬆️ 上行</div></div><div class="times-list"><div class="time-item">📭 暫時未有列車資訊</div></div></div>`;
                        }

                        // Group trains by destination and platform for DOWN direction
                        const downGroups = {};
                        if (stationData.DOWN) {
                            stationData.DOWN.forEach(train => {
                                const key = `${train.dest}-${train.plat}`;
                                if (!downGroups[key]) {
                                    downGroups[key] = {
                                        dest: train.dest,
                                        plat: train.plat,
                                        times: []
                                    };
                                }
                                downGroups[key].times.push(train.ttnt);
                            });
                        }

                        // Render DOWN groups
                        if (Object.keys(downGroups).length > 0) {
                            for (const key in downGroups) {
                                const group = downGroups[key];
                                const groupId = `group-${line}-DOWN-${group.dest}-${group.plat}`;
                                html += `
                                    <div class="direction-destination-platform-group" id="${groupId}">
                                        <div class="group-header">
                                            <div class="group-title-content">
                                                <span class="direction-destination-text">
                                                    ⬇️ 下行往 ${getDestinationName(group.dest)}
                                                </span>
                                                <span class="platform-info">月台${group.plat}</span>
                                            </div>
                                            <button class="refresh-btn" onclick="refreshGroup('${line}', '${station.code}', 'DOWN', '${group.dest}', '${group.plat}')">
                                                🔄 重新整理
                                            </button>
                                        </div>
                                        <div class="times-list">
                                `;
                                group.times.sort((a, b) => a - b).forEach(ttnt => { // Sort times
                                    html += formatArrivalTime(ttnt);
                                });
                                html += `
                                        </div>
                                    </div>
                                `;
                            }
                        } else {
                            html += `<div class="direction-destination-platform-group"><div class="group-header"><div class="group-title-content">⬇️ 下行</div></div><div class="times-list"><div class="time-item">📭 暫時未有列車資訊</div></div></div>`;
                        }
                    } else {
                        html += `<div class="error">❌ 呢條線嘅數據攞唔到。</div>`;
                    }
                }
                html += '</div>'; // Close line-section div
            });
            
            html += `
                <div class="footer">
                    ⏰ 最後更新: <span id="lastUpdatedTime">${new Date().toLocaleTimeString('zh-HK', { 
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    })}</span>
                    <br>
                    📊 數據來源：香港特別行政區政府
                </div>
            `;
            
            result.innerHTML = html;
        }
        
        // 獲取目的地名稱
        function getDestinationName(code) {
            const names = {
                'TSW': '荃灣', 'CEN': '中環', 'CHW': '柴灣', 'KET': '堅尼地城',
                'TIK': '調景嶺', 'WHA': '黃埔', 'POA': '寶琳', 'LOH': '康城',
                'NOP': '北角', 'LOW': '羅湖', 'LMC': '落馬洲', 'HUH': '紅磡',
                'SHS': '上水', 'ADM': '金鐘', 'TUM': '屯門', 'WKS': '烏溪沙',
                'TUC': '東涌', 'HOK': '香港', 'AIR': '機場', 'AWE': '博覽館',
                'DIS': '迪士尼', 'SOH': '海怡半島', 'OCP': '海洋公園', 
                'WCH': '黃竹坑', 'LET': '利東', 'EXC': '會展',
                'KOB': '九龍灣', 'TST': '尖沙咀', 'MOK': '旺角', 'YMT': '油麻地',
                'HKU': '香港大學', 'SYP': '西營盤', 'SHW': '上環', 'TIH': '天后',
                'FOH': '炮台山', 'TAK': '太古', 'SWN': '西灣河', 'SKW': '筲箕灣',
                'HFC': '杏花邨', 'HOM': '何文田', 'SKM': '石硤尾', 'LOF': '樂富',
                'WTS': '黃大仙', 'CHH': '彩虹', 'NTK': '牛頭角', 'LAT': '藍田',
                'JOR': '佐敦', 'SSP': '深水埗', 'CSW': '長沙灣', 'LCK': '荔枝角',
                'LAK': '荔景', 'KWF': '葵芳', 'KWH': '葵興', 'TWH': '大窩口',
                'HAK': '坑口', 'QUB': '鰂魚涌', 'YAT': '油塘', 'KOT': '九龍塘',
                'MKE': '旺角東', 'FOT': '火炭', 'RAC': '馬場', 'UNI': '大學',
                'TAP': '大埔墟', 'TWO': '太和', 'FAN': '粉嶺', 'MOS': '馬鞍山',
                'HEO': '恆安', 'TSH': '大水坑', 'SHM': '石門', 'CIO': '第一城',
                'STW': '沙田圍', 'CKT': '車公廟', 'HIK': '顯徑', 'KAT': '啟德',
                'SWT': '宋皇臺', 'TKW': '土瓜灣', 'ETS': '尖東', 'AUS': '柯士甸',
                'NAC': '南昌', 'TWW': '荃灣西', 'KSR': '錦上路', 'YUL': '元朗',
                'LGP': '朗屏', 'OLY': '奧運', 'TSY': '青衣', 'SUN': '欣澳',
                'TAW': '大圍', 'SHT': '沙田', 'MEF': '美孚', 'PRE': '太子',
                'CAB': '銅鑼灣', 'WAC': '灣仔', 'KWT': '觀塘', 'TKO': '將軍澳',
                'DIH': '鑽石山', 'KOW': '九龍'
            };
            return names[code] || code;
        }

        // Update the last updated time in the footer
        function updateFooterTime() {
            const timeElement = document.getElementById('lastUpdatedTime');
            if (timeElement) {
                timeElement.textContent = new Date().toLocaleTimeString('zh-HK', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        }
        
        // 按Enter鍵搜尋
        document.getElementById('stationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('suggestions').style.display = 'none';
                searchStation();
            }
        });
        
        // 點擊其他地方關閉建議
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.input-container')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });
        
        // 頁面載入時顯示最近搜尋
        window.onload = function() {
            loadRecentStations();
            
            // Auto-focus on input for better UX
            document.getElementById('stationInput').focus();
        };

        // Add keyboard navigation for suggestions
        document.getElementById('stationInput').addEventListener('keydown', function(e) {
            const suggestions = document.getElementById('suggestions');
            const items = suggestions.querySelectorAll('.suggestion-item');
            
            if (suggestions.style.display === 'none' || items.length === 0) return;
            
            let selectedIndex = -1;
            items.forEach((item, index) => {
                if (item.classList.contains('selected')) {
                    selectedIndex = index;
                    item.classList.remove('selected');
                }
            });
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                items[selectedIndex].classList.add('selected');
                items[selectedIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                items[selectedIndex].classList.add('selected');
                items[selectedIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                items[selectedIndex].click();
            } else if (e.key === 'Escape') {
                suggestions.style.display = 'none';
            }
        });
    </script>
</body>
</html>
