<!DOCTYPE html>
<html>
<head>
    <title>MTRåˆ°ç«™æ™‚é–“æŸ¥è©¢</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <style>
        /* MTRé¢¨æ ¼ */
        :root {
            --mtr-red: #b01c2e;  /* MTRç´…è‰² */
            --mtr-blue: #0075c2;
            --mtr-gray: #888b8d;
            --mtr-light-gray: #f2f2f2;
            --mtr-dark-gray: #333;
            --app-background: linear-gradient(135deg, #e0e0e0 0%, #f0f0f0 100%); /* æ›´æŸ”å’Œçš„èƒŒæ™¯ */
            --card-shadow: 0 6px 20px rgba(0,0,0,0.1); /* æ›´æ˜é¡¯çš„å¡ç‰‡é™°å½± */
            --button-shadow: 0 4px 12px rgba(0,117,194,0.3); /* æŒ‰éˆ•é™°å½± */
            --border-radius-lg: 18px; /* å¤§åœ“è§’ */
            --border-radius-md: 12px; /* ä¸­åœ“è§’ */
            --border-radius-sm: 8px; /* å°åœ“è§’ */
        }
        
        body {
            font-family: 'Inter', Arial, "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background: var(--app-background);
            margin: 0;
            padding: 0;
            color: var(--mtr-dark-gray);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* å°‡å…§å®¹å¾é ‚éƒ¨é–‹å§‹æ’åˆ— */
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»¾å‹• */
            padding-bottom: 20px; /* åº•éƒ¨ç•™ç™½ï¼Œæ¨¡æ“¬Appåº•éƒ¨å°èˆªæ¬„çš„ç©ºé–“ */
            box-sizing: border-box; /* ç¢ºä¿paddingä¸æœƒå¢åŠ ç¸½å¯¬åº¦ */
        }

        /* é‡å°iOSå®‰å…¨å€åŸŸçš„é¡å¤–å¡«å…… */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .header {
            background: linear-gradient(135deg, var(--mtr-red) 0%, #d01829 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border-bottom-left-radius: var(--border-radius-lg);
            border-bottom-right-radius: var(--border-radius-lg);
            position: sticky; /* è®“Headeråœ¨æ»¾å‹•æ™‚å›ºå®šåœ¨é ‚éƒ¨ */
            top: 0;
            width: 100%;
            z-index: 100;
            overflow: hidden;
            padding-top: calc(20px + env(safe-area-inset-top)); /* è€ƒæ…®å®‰å…¨å€ */
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(0deg); }
            50% { transform: translateX(0%) translateY(0%) rotate(180deg); }
        }
        
        .header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .mtr-logo {
            font-size: 2.5rem;
            margin-right: 15px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .container {
            max-width: 550px;
            width: calc(100% - 30px); /* å…©é‚Šå„15pxçš„é‚Šè· */
            margin: 20px auto; /* èª¿æ•´ä¸Šé‚Šè· */
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            backdrop-filter: blur(10px);
            flex-grow: 1; /* è®“å®¹å™¨ä½”æ“šå‰©é¤˜ç©ºé–“ */
        }
        
        .search-box {
            padding: 25px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
        }
        
        .input-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--mtr-gray);
            border-radius: var(--border-radius-md);
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: white;
            -webkit-appearance: none; /* ç§»é™¤iOSä¸Šçš„é»˜èªæ¨£å¼ */
        }
        
        input:focus {
            border-color: var(--mtr-blue);
            outline: none;
            box-shadow: 0 0 0 4px rgba(0, 117, 194, 0.2);
            transform: translateY(-2px);
        }
        
        input:hover {
            border-color: var(--mtr-blue);
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--mtr-blue) 0%, #005a9c 100%);
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: var(--button-shadow);
            position: relative;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šé«˜äº® */
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        button:hover::before {
            left: 100%;
        }
        
        button:hover {
            background: linear-gradient(135deg, #005a9c 0%, var(--mtr-blue) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,117,194,0.4);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(0,117,194,0.3);
        }
        
        .result {
            padding: 0;
            display: none;
        }
        
        .station-header {
            background: linear-gradient(135deg, var(--mtr-blue) 0%, #005a9c 100%);
            color: white;
            padding: 20px 25px;
            font-size: 1.4rem;
            font-weight: bold;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255,255,255,0.2); /* è®“headeråº•éƒ¨æœ‰åˆ†éš”ç·š */
        }
        
        .station-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="70" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
        }
        
        .station-en {
            color: rgba(255,255,255,0.9);
            font-size: 0.9em;
            font-weight: normal;
            margin-top: 8px;
        }
        
        .line-section {
            margin: 0;
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(135deg, #ffffff 0%, #fcfcfc 100%);
        }
        
        .line-badge {
            display: flex; /* ä½¿ç”¨flexboxå°é½Š */
            align-items: center;
            justify-content: space-between; /* å°‡å¾½ç« å’ŒæŒ‰éˆ•åˆ†é–‹ */
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            width: fit-content; /* è®“å¾½ç« å¯¬åº¦é©æ‡‰å…§å®¹ */
            /* Removed background from here, it will be set by JS dynamically */
        }
        
        .line-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: badge-shimmer 2s infinite;
        }
        
        @keyframes badge-shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        /* New styles for grouped display */
        .direction-destination-platform-group {
            background: linear-gradient(135deg, #ffffff 0%, #fcfcfc 100%); /* Changed to white background for the group */
            margin: 15px 0; /* Add margin between groups */
            padding: 15px 20px; /* Padding for the group card */
            border-radius: var(--border-radius-md); /* Rounded corners for the group card */
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); /* Lighter shadow for group cards */
            border: 1px solid #eee; /* Light border */
        }

        .group-header {
            font-weight: bold;
            font-size: 1.1rem; /* Slightly larger font for header */
            color: var(--mtr-dark-gray);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Space for refresh button */
        }

        /* æ–°å¢ï¼šç”¨æ–¼åŒ…è£¹æ–¹å‘ã€ç›®çš„åœ°å’Œæœˆå°è³‡è¨Šçš„å®¹å™¨ */
        .group-title-content {
            display: flex; /* ä½¿ç”¨flexboxæ§åˆ¶å…§éƒ¨å…ƒç´ æ’ç‰ˆ */
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
            align-items: baseline; /* è®“æ–‡å­—åŸºç·šå°é½Š */
            flex-grow: 1; /* å…è¨±å…¶ä½”æ“šå¯ç”¨ç©ºé–“ */
            margin-right: 10px; /* èˆ‡åˆ·æ–°æŒ‰éˆ•ä¹‹é–“ç•™é»ç©ºé–“ */
        }

        /* æ–°å¢ï¼šæ–¹å‘å’Œç›®çš„åœ°çš„æ–‡å­—æ¨£å¼ */
        .direction-destination-text {
            /* ç¹¼æ‰¿ group-header çš„å­—é«”å¤§å° */
            margin-right: 5px; /* åœ¨æœˆå°è³‡è¨Šä¹‹å‰ç•™é»å°ç©ºé–“ */
            white-space: nowrap; /* ç›¡é‡ä¿æŒæ–¹å‘å’Œç›®çš„åœ°åœ¨åŒä¸€è¡Œ */
        }

        /* æ–°å¢ï¼šæœˆå°è³‡è¨Šçš„æ¨£å¼ */
        .platform-info {
            font-size: 0.9em; /* æ¯”ä¸»æ–‡å­—ç¨å° */
            color: var(--mtr-gray); /* æ›´æŸ”å’Œçš„é¡è‰² */
            font-weight: normal; /* ä¸å¦‚ä¸»æ–‡å­—ç²—é«” */
            white-space: nowrap; /* ç›¡é‡ä¿æŒæœˆå°è³‡è¨Šåœ¨åŒä¸€è¡Œ */
        }

        /* é‡å°å°å±å¹•çš„éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 450px) {
            .group-title-content {
                flex-direction: column; /* åœ¨å°å±å¹•ä¸Šå°‡æ–¹å‘/ç›®çš„åœ°å’Œæœˆå°è³‡è¨Šå †ç–Šé¡¯ç¤º */
                align-items: flex-start;
            }
            .direction-destination-text {
                margin-right: 0;
                margin-bottom: 5px; /* å †ç–Šæ™‚ï¼Œåœ¨å…©è¡Œä¹‹é–“ç•™é»ç©ºé–“ */
            }
            .platform-info {
                font-size: 1rem; /* å †ç–Šæ™‚ï¼Œèª¿æ•´å­—é«”å¤§å° */
            }
        }

        .group-header .refresh-btn {
            margin-left: auto; /* Push refresh button to the right */
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 15px;
        }

        .times-list {
            display: flex;
            flex-wrap: wrap; /* Allow times to wrap to next line */
            gap: 10px; /* Space between time items */
            justify-content: flex-start; /* Align items to the start */
        }

        .time-item {
            font-weight: bold;
            color: var(--mtr-red);
            font-size: 18px; /* Slightly smaller for multiple items */
            background: linear-gradient(135deg, white 0%, #f9f9f9 100%);
            padding: 6px 12px; /* Smaller padding */
            border-radius: var(--border-radius-sm);
            box-shadow: 0 1px 5px rgba(0,0,0,0.08); /* Lighter shadow */
            border: 1px solid var(--mtr-red); /* Thinner border */
            animation: none; /* Remove pulse animation from individual times */
            flex-shrink: 0; /* Prevent shrinking */
        }
        
        .time-item.missed {
            color: #d9534f;
            font-size: 16px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #ffe0e0 0%, #ffcccc 100%);
            border: 1px solid #d9534f;
            animation: missed-shake 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes missed-shake {
            0% { transform: translateX(-2px); }
            100% { transform: translateX(2px); }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--mtr-gray);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0,0,0,0.1);
            border-left-color: var(--mtr-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .suggestions {
            background: white;
            border: 2px solid #ddd;
            border-radius: var(--border-radius-md);
            max-height: 250px;
            overflow-y: auto;
            position: absolute;
            width: calc(100% - 40px); /* è€ƒæ…®åˆ°è¼¸å…¥æ¡†çš„padding */
            max-width: 550px;
            z-index: 20;
            display: none;
            box-shadow: var(--card-shadow);
            top: 100%;
            left: 0;
            margin-top: 5px;
        }
        
        .suggestion-item {
            padding: 12px 18px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item:hover, .suggestion-item.selected { /* æ·»åŠ selectedæ¨£å¼ */
            background: linear-gradient(135deg, var(--mtr-light-gray) 0%, #e8e8e8 100%);
            transform: translateX(5px);
        }
        
        .error {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            padding: 18px;
            margin: 18px 25px;
            border-radius: var(--border-radius-md);
            border-left: 4px solid #ffc107;
            box-shadow: 0 2px 8px rgba(255,193,7,0.2);
        }
        
        .footer {
            padding: 18px;
            text-align: center;
            color: var(--mtr-gray);
            font-size: 12px;
            border-top: 1px solid #eee;
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            width: 100%; /* è®“footerä½”æ»¿å¯¬åº¦ */
            box-sizing: border-box;
        }
        
        /* The individual refresh button moved inside .group-header */
        .refresh-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            padding: 6px 12px; /* æ›´å°çš„padding */
            border-radius: 20px; /* æ›´åœ“çš„æŒ‰éˆ• */
            font-size: 12px; /* æ›´å°çš„å­—é«” */
            margin-left: 10px; /* Space from badge */
            box-shadow: 0 2px 6px rgba(40,167,69,0.2); /* æ›´è¼•çš„é™°å½± */
            width: auto; /* Auto width */
            display: inline-flex; /* Make it inline-flex for spinner alignment */
            align-items: center; /* Align items vertically */
            vertical-align: middle; /* Align with text */
            white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ›è¡Œ */
            border: none; /* Remove default button border */
            color: white; /* Ensure text color is white */
            cursor: pointer; /* Indicate it's clickable */
            transition: all 0.3s ease; /* Smooth transitions */
        }
        
        .refresh-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1c7a5a 100%);
            box-shadow: 0 3px 9px rgba(40,167,69,0.3); /* Slightly larger shadow on hover */
            transform: translateY(-1px); /* Slight lift on hover */
        }

        .refresh-btn:active {
            transform: translateY(0); /* Press effect */
            box-shadow: 0 1px 3px rgba(40,167,69,0.2);
        }

        .refresh-btn .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.5);
            border-left-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 5px;
        }
        
        .direction-header {
            /* This style is now largely replaced by .group-header */
            background: linear-gradient(135deg, var(--mtr-light-gray) 0%, #e8e8e8 100%);
            padding: 10px 18px;
            margin: 18px 0 12px;
            border-radius: var(--border-radius-sm);
            font-weight: bold;
            color: #333;
            border-left: 4px solid var(--mtr-blue);
        }
        
        .emoji {
            margin-right: 8px;
        }
        
        .recent-stations {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        
        .recent-title {
            font-size: 14px;
            color: var(--mtr-gray);
            margin-bottom: 12px;
            font-weight: 600;
            display: flex; /* Use flexbox for title and clear button */
            justify-content: space-between; /* Space them out */
            align-items: center;
        }

        .clear-recent-btn {
            background: none;
            border: none;
            color: var(--mtr-gray);
            font-size: 12px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.3s ease;
            width: auto; /* Override button default width */
            text-align: right;
            box-shadow: none; /* Remove button shadow */
        }

        .clear-recent-btn:hover {
            color: var(--mtr-red);
            background: var(--mtr-light-gray);
            transform: translateY(-1px);
        }
        
        .recent-item {
            display: inline-block;
            background: linear-gradient(135deg, var(--mtr-light-gray) 0%, #e8e8e8 100%);
            padding: 10px 16px;
            margin: 0 8px 8px 0;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .recent-item:hover {
            background: linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%);
            transform: translateY(-2px);
            border-color: var(--mtr-blue);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Custom Message Box Styles */
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* æ›´æ·±çš„èƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(8px); /* æ›´å¼·çš„æ¨¡ç³Šæ•ˆæœ */
        }

        .message-box-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .message-box-content {
            background: linear-gradient(135deg, white 0%, #f9f9f9 100%);
            padding: 35px;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4); /* æ›´å¤§çš„é™°å½± */
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å½ˆæ€§å‹•ç•« */
        }

        .message-box-overlay.show .message-box-content {
            transform: scale(1);
        }

        .message-box-content h3 {
            margin-top: 0;
            color: var(--mtr-red);
            font-size: 1.6rem;
            margin-bottom: 18px;
        }

        .message-box-content p {
            margin-bottom: 28px;
            font-size: 1.1rem;
            color: var(--mtr-dark-gray);
            line-height: 1.6;
        }

        .message-box-content button {
            background: linear-gradient(135deg, var(--mtr-blue) 0%, #005a9c 100%);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            width: auto;
        }

        .message-box-content button:hover {
            background: linear-gradient(135deg, #005a9c 0%, var(--mtr-blue) 100%);
            transform: translateY(-2px);
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .container {
                margin: 15px;
                border-radius: var(--border-radius-lg);
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .mtr-logo {
                font-size: 2rem;
            }
            
            .search-box {
                padding: 20px;
            }
            
            input {
                padding: 12px 15px;
                font-size: 16px;
            }
            
            button {
                padding: 12px;
                font-size: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <div class="mtr-logo">ğŸš‡</div>
            MTRåˆ°ç«™æ™‚é–“æŸ¥è©¢
        </h1>
    </div>
    
    <div class="container">
        <div class="search-box">
            <div class="input-container">
                <input 
                    type="text" 
                    id="stationInput" 
                    placeholder="ğŸ” è¼¸å…¥è»Šç«™åç¨± (ä¾‹å¦‚: é‡‘é˜, Admiralty)" 
                    oninput="showSuggestions()"
                >
                <div id="suggestions" class="suggestions"></div>
            </div>
            <button onclick="searchStation()">ğŸš† æŸ¥è©¢åˆ°ç«™æ™‚é–“</button>
            
            <div id="recentStations" class="recent-stations">
                <div class="recent-title">
                    ğŸ“ æœ€è¿‘æœå°‹
                    <button class="clear-recent-btn" onclick="clearRecentStations()">æ¸…ç©º</button>
                </div>
                <div id="recentList"></div>
            </div>
        </div>
        
        <div id="result" class="result"></div>
    </div>

    <!-- Custom Message Box HTML -->
    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box-content">
            <h3 id="messageBoxTitle"></h3>
            <p id="messageBoxText"></p>
            <button onclick="hideMessage()">ç¢ºèª</button>
        </div>
    </div>

    <script>
        // è»Šç«™è³‡æ–™ (ä¸­è‹±æ–‡)
        const stations = {
            'é‡‘é˜': { code: 'ADM', en: 'Admiralty', lines: ['TWL', 'ISL', 'SIL', 'EAL'] },
            'ä¸­ç’°': { code: 'CEN', en: 'Central', lines: ['TWL', 'ISL'] },
            'å°–æ²™å’€': { code: 'TST', en: 'Tsim Sha Tsui', lines: ['TWL'] },
            'æ—ºè§’': { code: 'MOK', en: 'Mong Kok', lines: ['TWL', 'KTL'] },
            'æ²¹éº»åœ°': { code: 'YMT', en: 'Yau Ma Tei', lines: ['TWL', 'KTL'] },
            'ä¹é¾å¡˜': { code: 'KOT', en: 'Kowloon Tong', lines: ['KTL', 'EAL'] },
            'æ²¹å¡˜': { code: 'YAT', en: 'Yau Tong', lines: ['KTL', 'TKL'] },
            'èª¿æ™¯å¶º': { code: 'TIK', en: 'Tiu Keng Leng', lines: ['KTL', 'TKL'] },
            'åŒ—è§’': { code: 'NOP', en: 'North Point', lines: ['ISL', 'TKL'] },
            'é°‚é­šæ¶Œ': { code: 'QUB', en: 'Quarry Bay', lines: ['ISL', 'TKL'] },
            'å¤§åœ': { code: 'TAW', en: 'Tai Wai', lines: ['EAL', 'TML'] },
            'æ²™ç”°': { code: 'SHT', en: 'Sha Tin', lines: ['EAL'] },
            'èƒç£': { code: 'TSW', en: 'Tsuen Wan', lines: ['TWL'] },
            'æ±æ¶Œ': { code: 'TUC', en: 'Tung Chung', lines: ['TCL'] },
            'é¦™æ¸¯': { code: 'HOK', en: 'Hong Kong', lines: ['TCL', 'AEL'] },
            'ä¹é¾': { code: 'KOW', en: 'Kowloon', lines: ['TCL', 'AEL'] },
            'æœƒå±•': { code: 'EXC', en: 'Exhibition Centre', lines: ['EAL'] },
            'ç´…ç£¡': { code: 'HUH', en: 'Hung Hom', lines: ['EAL', 'TML'] },
            'é‘½çŸ³å±±': { code: 'DIH', en: 'Diamond Hill', lines: ['KTL', 'TML'] },
            'ç¾å­š': { code: 'MEF', en: 'Mei Foo', lines: ['TWL', 'TML'] },
            'å¤ªå­': { code: 'PRE', en: 'Prince Edward', lines: ['TWL', 'KTL'] },
            'éŠ…é‘¼ç£': { code: 'CAB', en: 'Causeway Bay', lines: ['ISL'] },
            'ç£ä»”': { code: 'WAC', en: 'Wan Chai', lines: ['ISL'] },
            'æŸ´ç£': { code: 'CHW', en: 'Chai Wan', lines: ['ISL'] },
            'é»ƒåŸ”': { code: 'WHA', en: 'Whampoa', lines: ['KTL'] },
            'è§€å¡˜': { code: 'KWT', en: 'Kwun Tong', lines: ['KTL'] },
            'ä¹é¾ç£': { code: 'KOB', en: 'Kowloon Bay', lines: ['KTL'] },
            'å°‡è»æ¾³': { code: 'TKO', en: 'Tseung Kwan O', lines: ['TKL'] },
            'å¯¶ç³': { code: 'POA', en: 'Po Lam', lines: ['TKL'] },
            'åº·åŸ': { code: 'LOH', en: 'LOHAS Park', lines: ['TKL'] },
            'ä¸Šæ°´': { code: 'SHS', en: 'Sheung Shui', lines: ['EAL'] },
            'ç¾…æ¹–': { code: 'LOW', en: 'Lo Wu', lines: ['EAL'] },
            'è½é¦¬æ´²': { code: 'LMC', en: 'Lok Ma Chau', lines: ['EAL'] },
            'çƒæºªæ²™': { code: 'WKS', en: 'Wu Kai Sha', lines: ['TML'] },
            'å±¯é–€': { code: 'TUM', en: 'Tuen Mun', lines: ['TML'] },
            'é’è¡£': { code: 'TSY', en: 'Tsing Yi', lines: ['TCL', 'AEL'] },
            'æ©Ÿå ´': { code: 'AIR', en: 'Airport', lines: ['AEL'] },
            'æµ·æ€¡åŠå³¶': { code: 'SOH', en: 'South Horizons', lines: ['SIL'] },
            'æµ·æ´‹å…¬åœ’': { code: 'OCP', en: 'Ocean Park', lines: ['SIL'] },
            'é»ƒç«¹å‘': { code: 'WCH', en: 'Wong Chuk Hang', lines: ['SIL'] },
            'åˆ©æ±': { code: 'LET', en: 'Lei Tung', lines: ['SIL'] },
            'è¿ªå£«å°¼': { code: 'DIS', en: 'Disneyland Resort', lines: ['DRL'] },
            'æ¬£æ¾³': { code: 'SUN', en: 'Sunny Bay', lines: ['TCL', 'DRL'] },
            // æ–°å¢çš„è»Šç«™
            'é¦™æ¸¯å¤§å­¸': { code: 'HKU', en: 'HKU', lines: ['ISL'] },
            'è¥¿ç‡Ÿç›¤': { code: 'SYP', en: 'Sai Ying Pun', lines: ['ISL'] },
            'ä¸Šç’°': { code: 'SHW', en: 'Sheung Wan', lines: ['ISL'] },
            'å¤©å': { code: 'TIH', en: 'Tin Hau', lines: ['ISL'] },
            'ç‚®å°å±±': { code: 'FOH', en: 'Fortress Hill', lines: ['ISL'] },
            'å¤ªå¤': { code: 'TAK', en: 'Tai Koo', lines: ['ISL'] },
            'è¥¿ç£æ²³': { code: 'SWN', en: 'Sai Wan Ho', lines: ['ISL'] },
            'ç­²ç®•ç£': { code: 'SKW', en: 'Shau Kei Wan', lines: ['ISL'] },
            'æèŠ±é‚¨': { code: 'HFC', en: 'Heng Fa Chuen', lines: ['ISL'] },
            'ä½•æ–‡ç”°': { code: 'HOM', en: 'Ho Man Tin', lines: ['KTL', 'TML'] },
            'çŸ³ç¡¤å°¾': { code: 'SKM', en: 'Shek Kip Mei', lines: ['KTL'] },
            'æ¨‚å¯Œ': { code: 'LOF', en: 'Lok Fu', lines: ['KTL'] },
            'é»ƒå¤§ä»™': { code: 'WTS', en: 'Wong Tai Sin', lines: ['KTL'] },
            'å½©è™¹': { code: 'CHH', en: 'Choi Hung', lines: ['KTL'] },
            'ç‰›é ­è§’': { code: 'NTK', en: 'Ngau Tau Kok', lines: ['KTL'] },
            'è—ç”°': { code: 'LAT', en: 'Lam Tin', lines: ['KTL'] },
            'ä½æ•¦': { code: 'JOR', en: 'Jordan', lines: ['TWL'] },
            'æ·±æ°´åŸ—': { code: 'SSP', en: 'Sham Shui Po', lines: ['TWL'] },
            'é•·æ²™ç£': { code: 'CSW', en: 'Cheung Sha Wan', lines: ['TWL'] },
            'è”æè§’': { code: 'LCK', en: 'Lai Chi Kok', lines: ['TWL'] },
            'è”æ™¯': { code: 'LAK', en: 'Lai King', lines: ['TWL', 'TCL'] },
            'è‘µèŠ³': { code: 'KWF', en: 'Kwai Fong', lines: ['TWL'] },
            'è‘µèˆˆ': { code: 'KWH', en: 'Kwai Hing', lines: ['TWL'] },
            'å¤§çª©å£': { code: 'TWH', en: 'Tai Wo Hau', lines: ['TWL'] },
            'å‘å£': { code: 'HAK', en: 'Hang Hau', lines: ['TKL'] },
            'æ—ºè§’æ±': { code: 'MKE', en: 'Mong Kok East', lines: ['EAL'] },
            'ç«ç‚­': { code: 'FOT', en: 'Fo Tan', lines: ['EAL'] },
            'é¦¬å ´': { code: 'RAC', en: 'Racecourse', lines: ['EAL'] },
            'å¤§å­¸': { code: 'UNI', en: 'University', lines: ['EAL'] },
            'å¤§åŸ”å¢Ÿ': { code: 'TAP', en: 'Tai Po Market', lines: ['EAL'] },
            'å¤ªå’Œ': { code: 'TWO', en: 'Tai Wo', lines: ['EAL'] },
            'ç²‰å¶º': { code: 'FAN', en: 'Fanling', lines: ['EAL'] },
            'é¦¬éå±±': { code: 'MOS', en: 'Ma On Shan', lines: ['TML'] },
            'æ†å®‰': { code: 'HEO', en: 'Heng On', lines: ['TML'] },
            'å¤§æ°´å‘': { code: 'TSH', en: 'Tai Shui Hang', lines: ['TML'] },
            'çŸ³é–€': { code: 'SHM', en: 'Shek Mun', lines: ['TML'] },
            'ç¬¬ä¸€åŸ': { code: 'CIO', en: 'City One', lines: ['TML'] },
            'æ²™ç”°åœ': { code: 'STW', en: 'Sha Tin Wai', lines: ['TML'] },
            'è»Šå…¬å»Ÿ': { code: 'CKT', en: 'Che Kung Temple', lines: ['TML'] },
            'é¡¯å¾‘': { code: 'HIK', en: 'Hin Keng', lines: ['TML'] },
            'å•Ÿå¾·': { code: 'KAT', en: 'Kai Tak', lines: ['TML'] },
            'å®‹çš‡è‡º': { code: 'SWT', en: 'Sung Wong Toi', lines: ['TML'] },
            'åœŸç“œç£': { code: 'TKW', en: 'To Kwa Wan', lines: ['TML'] },
            'å°–æ±': { code: 'ETS', en: 'East Tsim Sha Tsui', lines: ['TML'] },
            'æŸ¯å£«ç”¸': { code: 'AUS', en: 'Austin', lines: ['TML'] },
            'å—æ˜Œ': { code: 'NAC', en: 'Nam Cheong', lines: ['TCL', 'TML'] },
            'èƒç£è¥¿': { code: 'TWW', en: 'Tsuen Wan West', lines: ['TML'] },
            'éŒ¦ä¸Šè·¯': { code: 'KSR', en: 'Kam Sheung Road', lines: ['TML'] },
            'å…ƒæœ—': { code: 'YUL', en: 'Yuen Long', lines: ['TML'] },
            'æœ—å±': { code: 'LGP', en: 'Long Ping', lines: ['TML'] },
            'å¥§é‹': { code: 'OLY', en: 'Olympic', lines: ['TCL'] },
            'åšè¦½é¤¨': { code: 'AWE', en: 'AsiaWorld-Expo', lines: ['AEL'] }
        };
        
        // ç·šè·¯å°æ‡‰çš„emoji
        const lineEmojis = {
            'TWL': 'ğŸ”´', // èƒç£ç·š
            'ISL': 'ğŸ”µ', // æ¸¯å³¶ç·š
            'KTL': 'ğŸŸ¢', // è§€å¡˜ç·š
            'TKL': 'ğŸŸ£', // å°‡è»æ¾³ç·š
            'EAL': 'ğŸ”·', // æ±éµç·š
            'TML': 'ğŸŸ¤', // å±¯é¦¬ç·š
            'TCL': 'ğŸŸ ', // æ±æ¶Œç·š
            'AEL': 'ğŸŸ¦', // æ©Ÿå ´å¿«ç¶«
            'SIL': 'ğŸŸ¡', // å—æ¸¯å³¶ç·š
            'DRL': 'ğŸŸª'  // è¿ªå£«å°¼ç·š
        };
        
        // å»ºç«‹è‹±æ–‡åˆ°ä¸­æ–‡çš„æ˜ å°„
        const enToZh = {};
        for (const [zh, data] of Object.entries(stations)) {
            enToZh[data.en.toLowerCase()] = zh;
        }
        
        // ç·šè·¯è³‡æ–™
        const lines = {
            'TWL': { name: 'èƒç£ç·š', color: '#E2231A' },
            'ISL': { name: 'æ¸¯å³¶ç·š', color: '#0860A8' },
            'KTL': { name: 'è§€å¡˜ç·š', color: '#7ED321' },
            'TKL': { name: 'å°‡è»æ¾³ç·š', color: '#7B91C6' },
            'EAL': { name: 'æ±éµç·š', color: '#5EB3F5' },
            'TML': { name: 'å±¯é¦¬ç·š', color: '#8D6019' },
            'TCL': { name: 'æ±æ¶Œç·š', color: '#F7931D' },
            'AEL': { name: 'æ©Ÿå ´å¿«ç¶«', color: '#1C7670' },
            'SIL': { name: 'å—æ¸¯å³¶ç·š', color: '#CBCD09' },
            'DRL': { name: 'è¿ªå£«å°¼ç·š', color: '#F550A6' }
        };
        
        /**
         * Displays a custom message box instead of using alert().
         * @param {string} title - The title of the message box.
         * @param {string} message - The message to display.
         */
        function showMessage(title, message) {
            document.getElementById('messageBoxTitle').textContent = title;
            document.getElementById('messageBoxText').textContent = message;
            document.getElementById('messageBoxOverlay').classList.add('show');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessage() {
            document.getElementById('messageBoxOverlay').classList.remove('show');
        }

        /**
         * Loads and displays recent stations from local storage.
         */
        function loadRecentStations() {
            const recentStations = JSON.parse(localStorage.getItem('recentStations') || '[]');
            const recentList = document.getElementById('recentList');
            const recentStationsContainer = document.getElementById('recentStations');
            
            if (recentStations.length === 0) {
                recentStationsContainer.style.display = 'none';
                return;
            }
            
            recentStationsContainer.style.display = 'block';
            recentList.innerHTML = '';
            
            recentStations.forEach(station => {
                const item = document.createElement('span');
                item.className = 'recent-item';
                item.textContent = station;
                item.onclick = () => {
                    document.getElementById('stationInput').value = station;
                    searchStation();
                };
                recentList.appendChild(item);
            });
        }
        
        /**
         * Saves a station name to recent searches in local storage.
         * @param {string} stationName - The name of the station to save.
         */
        function saveRecentStation(stationName) {
            let recentStations = JSON.parse(localStorage.getItem('recentStations') || '[]');
            
            // å¦‚æœå·²ç¶“å­˜åœ¨ï¼Œå…ˆç§»é™¤èˆŠçš„
            recentStations = recentStations.filter(s => s !== stationName);
            
            // æ·»åŠ åˆ°æœ€å‰é¢
            recentStations.unshift(stationName);
            
            // åªä¿ç•™æœ€è¿‘5å€‹
            if (recentStations.length > 5) {
                recentStations = recentStations.slice(0, 5);
            }
            
            localStorage.setItem('recentStations', JSON.stringify(recentStations));
            loadRecentStations();
        }

        /**
         * Clears all recent stations from local storage.
         */
        function clearRecentStations() {
            localStorage.removeItem('recentStations');
            loadRecentStations(); // Re-render to show empty state
            showMessage('å·²æ¸…ç©º', 'æœ€è¿‘æœå°‹è¨˜éŒ„å·²å…¨éƒ¨æ¸…é™¤ã€‚');
        }
        
        // é¡¯ç¤ºå»ºè­°çš„timeout ID
        let suggestionTimeout;
        /**
         * Shows station suggestions based on user input.
         */
        function showSuggestions() {
            clearTimeout(suggestionTimeout);
            suggestionTimeout = setTimeout(() => {
                const input = document.getElementById('stationInput').value.trim().toLowerCase();
                const suggestionsDiv = document.getElementById('suggestions');
                
                if (input.length < 1) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }
                
                // æœå°‹ä¸­æ–‡å’Œè‹±æ–‡åç¨±
                const matchedStations = [];
                
                // æœå°‹ä¸­æ–‡åç¨±
                Object.keys(stations).forEach(zh => {
                    if (zh.toLowerCase().includes(input)) {
                        matchedStations.push({ zh, en: stations[zh].en });
                    }
                });
                
                // æœå°‹è‹±æ–‡åç¨±
                Object.keys(enToZh).forEach(en => {
                    if (en.includes(input) && !matchedStations.some(s => s.zh === enToZh[en])) {
                        matchedStations.push({ zh: enToZh[en], en: stations[enToZh[en]].en });
                    }
                });
                
                if (matchedStations.length > 0) {
                    let html = '';
                    matchedStations.slice(0, 8).forEach(station => {
                        html += `
                            <div class="suggestion-item" onclick="selectStation('${station.zh}')">
                                ğŸš‰ ${station.zh} <span class="station-en">(${station.en})</span>
                            </div>
                        `;
                    });
                    
                    suggestionsDiv.innerHTML = html;
                    suggestionsDiv.style.display = 'block';
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            }, 200); // Debounce time
        }
        
        /**
         * Selects a station from suggestions and triggers a search.
         * @param {string} station - The name of the selected station.
         */
        function selectStation(station) {
            document.getElementById('stationInput').value = station;
            document.getElementById('suggestions').style.display = 'none';
            searchStation();
        }
        
        // å„²å­˜ç•¶å‰æŸ¥è©¢çš„è»Šç«™è³‡è¨Šï¼Œä»¥ä¾¿å–®ç¨é‡æ–°æ•´ç†
        let currentStationData = null;

        /**
         * Initiates the search for MTR arrival times for the entered station.
         */
        async function searchStation() {
            let stationName = document.getElementById('stationInput').value.trim();
            
            if (!stationName) {
                showMessage('è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥è»Šç«™åç¨±');
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æ˜¯è‹±æ–‡åç¨±
            const lowerInput = stationName.toLowerCase();
            if (enToZh[lowerInput]) {
                stationName = enToZh[lowerInput];
            }
            
            const station = stations[stationName];
            if (!station) {
                document.getElementById('result').style.display = 'block';
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        âš ï¸ æµå””åˆ°ã€Œ${stationName}ã€å‘¢å€‹ç«™å–ï¼Œéº»ç…©ä½ ç‡å“ä¿‚å’ªæ‰“éŒ¯å­—ï¼Ÿ
                        <br>ä¾‹å¦‚ï¼šé‡‘é˜(Admiralty)ã€ä¸­ç’°(Central)ã€æ—ºè§’(Mong Kok)éƒ½å¾—ã—ã€‚
                    </div>
                `;
                return;
            }
            
            // ä¿å­˜åˆ°æœ€è¿‘æœå°‹
            saveRecentStation(stationName);
            
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>â³ åŠªåŠ›å¹«ä½ æµç·Šåˆ°ç«™æ™‚é–“...</div>
                </div>
            `;
            
            // Store current station data globally for individual line refresh
            currentStationData = {
                name: stationName,
                code: station.code,
                en: station.en,
                lines: station.lines
            };

            try {
                // Fetch data for all lines concurrently
                const promises = station.lines.map(line => 
                    fetch(`https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line=${line}&sta=${station.code}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => ({ line, data }))
                        .catch(error => ({ line, error }))
                );
                
                const results = await Promise.all(promises);
                displayAllLines(results, stationName, station);
                
            } catch (error) {
                console.error('Error fetching MTR data:', error);
                result.innerHTML = '<div class="error">âŒ å””å¥½æ„æ€ï¼Œå¥½ä¼¼æœ‰å•²å•é¡Œï¼Œè«‹æª¢æŸ¥ä¸‹ä½ å€‹ç¶²çµ¡æˆ–è€…é²å•²å†è©¦éå•¦ã€‚</div>';
            }
        }

        /**
         * Formats the arrival time into a displayable HTML string.
         * @param {number} ttnt - Time to next train in minutes.
         * @returns {string} HTML string for the time item.
         */
        function formatArrivalTime(ttnt) {
            const displayTime = (ttnt === 0 || ttnt === 1) ? "è¶•å””åˆ‡å•¦ ğŸ˜­ğŸ˜­" : `${ttnt} åˆ†é˜`;
            const timeClass = (ttnt === 0 || ttnt === 1) ? "time-item missed" : "time-item";
            return `<div class="${timeClass}">â±ï¸ ${displayTime}</div>`;
        }

        /**
         * Refreshes data for a specific line and a specific direction/destination/platform group.
         * @param {string} lineCode - The MTR line code (e.g., 'TWL').
         * @param {string} stationCode - The MTR station code (e.g., 'ADM').
         * @param {string} direction - 'UP' or 'DOWN'.
         * @param {string} destinationCode - The destination station code.
         * @param {string} platform - The platform number.
         */
        async function refreshGroup(lineCode, stationCode, direction, destinationCode, platform) {
            const groupId = `group-${lineCode}-${direction}-${destinationCode}-${platform}`;
            const targetGroup = document.getElementById(groupId);
            const refreshButton = targetGroup.querySelector('.refresh-btn');
            const originalButtonText = refreshButton.innerHTML;

            if (!targetGroup) {
                console.error(`Error: Group with ID ${groupId} not found.`);
                return;
            }

            // Show loading spinner on the button
            refreshButton.disabled = true;
            refreshButton.innerHTML = '<span class="spinner"></span> æ›´æ–°ä¸­...';

            try {
                const response = await fetch(`https://rt.data.gov.hk/v1/transport/mtr/getSchedule.php?line=${lineCode}&sta=${stationCode}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                let groupHtml = `
                    <div class="group-header">
                        <div class="group-title-content">
                            <span class="direction-destination-text">
                                ${direction === 'UP' ? 'â¬†ï¸ ä¸Šè¡Œ' : 'â¬‡ï¸ ä¸‹è¡Œ'}å¾€ ${getDestinationName(destinationCode)}
                            </span>
                            <span class="platform-info">æœˆå°${platform}</span>
                        </div>
                        <button class="refresh-btn" onclick="refreshGroup('${lineCode}', '${stationCode}', '${direction}', '${destinationCode}', '${platform}')">
                            ğŸ”„ é‡æ–°æ•´ç†
                        </button>
                    </div>
                    <div class="times-list">
                `;

                if (data.status === 1) {
                    const stationData = data.data[`${lineCode}-${stationCode}`];
                    if (stationData && stationData[direction]) {
                        const filteredTrains = stationData[direction].filter(train => 
                            train.dest === destinationCode && train.plat === platform
                        );
                        if (filteredTrains.length > 0) {
                            filteredTrains.sort((a, b) => a.ttnt - b.ttnt).forEach(train => {
                                groupHtml += formatArrivalTime(train.ttnt);
                            });
                        } else {
                            groupHtml += `<div class="time-item">ğŸ“­ æš«æ™‚æœªæœ‰åˆ—è»Šè³‡è¨Š</div>`;
                        }
                    } else {
                        groupHtml += `<div class="time-item error-small">âŒ æ”å””åˆ°æ•¸æ“š</div>`;
                    }
                } else {
                    groupHtml += `<div class="time-item error-small">âŒ æœå‹™æš«æ™‚ç”¨å””åˆ°</div>`;
                }
                groupHtml += `</div>`; // Close times-list
                targetGroup.innerHTML = groupHtml;

            } catch (error) {
                console.error(`Error refreshing group ${groupId} data:`, error);
                targetGroup.innerHTML = `
                    <div class="group-header">
                        <div class="group-title-content">
                            <span class="direction-destination-text">
                                ${direction === 'UP' ? 'â¬†ï¸ ä¸Šè¡Œ' : 'â¬‡ï¸ ä¸‹è¡Œ'}å¾€ ${getDestinationName(destinationCode)}
                            </span>
                            <span class="platform-info">æœˆå°${platform}</span>
                        </div>
                        <button class="refresh-btn" onclick="refreshGroup('${lineCode}', '${stationCode}', '${direction}', '${destinationCode}', '${platform}')">
                            ğŸ”„ é‡æ–°æ•´ç†
                        </button>
                    </div>
                    <div class="time-item error-small">âŒ åˆ·æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡ã€‚</div>
                `;
            } finally {
                // Restore button state - this part is handled by re-rendering the whole group,
                // but good practice to consider if only partial updates were done.
            }
            updateFooterTime(); // Update the overall last updated time
        }

        /**
         * Displays arrival times for all lines of a given station.
         * @param {Array<Object>} results - Array of fetch results for each line.
         * @param {string} stationName - Chinese name of the station.
         * @param {Object} station - Station data object.
         */
        function displayAllLines(results, stationName, station) {
            const result = document.getElementById('result');
            let html = `
                <div class="station-header">
                    ğŸš‰ ${stationName}
                    <div class="station-en">${station.en}</div>
                </div>
            `;
            
            results.forEach(({ line, data, error }) => {
                const lineSectionId = `line-section-${line}`;
                html += `<div class="line-section" id="${lineSectionId}">`;

                html += `
                    <div class="line-badge" style="background-color: ${lines[line].color}">
                        ${lineEmojis[line]} ${lines[line].name}
                    </div>
                `;

                if (error || data.status !== 1) {
                    html += `<div class="error">âŒ å‘¢æ¢ç·šå˜…æ•¸æ“šæ”å””åˆ°ï¼Œæˆ–è€…æœå‹™æš«æ™‚ç”¨å””åˆ°ã€‚</div>`;
                } else {
                    const stationData = data.data[`${line}-${station.code}`];
                    if (stationData) {
                        // Group trains by destination and platform for UP direction
                        const upGroups = {};
                        if (stationData.UP) {
                            stationData.UP.forEach(train => {
                                const key = `${train.dest}-${train.plat}`;
                                if (!upGroups[key]) {
                                    upGroups[key] = {
                                        dest: train.dest,
                                        plat: train.plat,
                                        times: []
                                    };
                                }
                                upGroups[key].times.push(train.ttnt);
                            });
                        }

                        // Render UP groups
                        if (Object.keys(upGroups).length > 0) {
                            for (const key in upGroups) {
                                const group = upGroups[key];
                                const groupId = `group-${line}-UP-${group.dest}-${group.plat}`;
                                html += `
                                    <div class="direction-destination-platform-group" id="${groupId}">
                                        <div class="group-header">
                                            <div class="group-title-content">
                                                <span class="direction-destination-text">
                                                    â¬†ï¸ ä¸Šè¡Œå¾€ ${getDestinationName(group.dest)}
                                                </span>
                                                <span class="platform-info">æœˆå°${group.plat}</span>
                                            </div>
                                            <button class="refresh-btn" onclick="refreshGroup('${line}', '${station.code}', 'UP', '${group.dest}', '${group.plat}')">
                                                ğŸ”„ é‡æ–°æ•´ç†
                                            </button>
                                        </div>
                                        <div class="times-list">
                                `;
                                group.times.sort((a, b) => a - b).forEach(ttnt => { // Sort times
                                    html += formatArrivalTime(ttnt);
                                });
                                html += `
                                        </div>
                                    </div>
                                `;
                            }
                        } else {
                            html += `<div class="direction-destination-platform-group"><div class="group-header"><div class="group-title-content">â¬†ï¸ ä¸Šè¡Œ</div></div><div class="times-list"><div class="time-item">ğŸ“­ æš«æ™‚æœªæœ‰åˆ—è»Šè³‡è¨Š</div></div></div>`;
                        }

                        // Group trains by destination and platform for DOWN direction
                        const downGroups = {};
                        if (stationData.DOWN) {
                            stationData.DOWN.forEach(train => {
                                const key = `${train.dest}-${train.plat}`;
                                if (!downGroups[key]) {
                                    downGroups[key] = {
                                        dest: train.dest,
                                        plat: train.plat,
                                        times: []
                                    };
                                }
                                downGroups[key].times.push(train.ttnt);
                            });
                        }

                        // Render DOWN groups
                        if (Object.keys(downGroups).length > 0) {
                            for (const key in downGroups) {
                                const group = downGroups[key];
                                const groupId = `group-${line}-DOWN-${group.dest}-${group.plat}`;
                                html += `
                                    <div class="direction-destination-platform-group" id="${groupId}">
                                        <div class="group-header">
                                            <div class="group-title-content">
                                                <span class="direction-destination-text">
                                                    â¬‡ï¸ ä¸‹è¡Œå¾€ ${getDestinationName(group.dest)}
                                                </span>
                                                <span class="platform-info">æœˆå°${group.plat}</span>
                                            </div>
                                            <button class="refresh-btn" onclick="refreshGroup('${line}', '${station.code}', 'DOWN', '${group.dest}', '${group.plat}')">
                                                ğŸ”„ é‡æ–°æ•´ç†
                                            </button>
                                        </div>
                                        <div class="times-list">
                                `;
                                group.times.sort((a, b) => a - b).forEach(ttnt => { // Sort times
                                    html += formatArrivalTime(ttnt);
                                });
                                html += `
                                        </div>
                                    </div>
                                `;
                            }
                        } else {
                            html += `<div class="direction-destination-platform-group"><div class="group-header"><div class="group-title-content">â¬‡ï¸ ä¸‹è¡Œ</div></div><div class="times-list"><div class="time-item">ğŸ“­ æš«æ™‚æœªæœ‰åˆ—è»Šè³‡è¨Š</div></div></div>`;
                        }
                    } else {
                        html += `<div class="error">âŒ å‘¢æ¢ç·šå˜…æ•¸æ“šæ”å””åˆ°ã€‚</div>`;
                    }
                }
                html += '</div>'; // Close line-section div
            });
            
            html += `
                <div class="footer">
                    â° æœ€å¾Œæ›´æ–°: <span id="lastUpdatedTime">${new Date().toLocaleTimeString('zh-HK', { 
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    })}</span>
                    <br>
                    ğŸ“Š æ•¸æ“šä¾†æºï¼šé¦™æ¸¯ç‰¹åˆ¥è¡Œæ”¿å€æ”¿åºœ
                </div>
            `;
            
            result.innerHTML = html;
        }
        
        // ç²å–ç›®çš„åœ°åç¨±
        function getDestinationName(code) {
            const names = {
                'TSW': 'èƒç£', 'CEN': 'ä¸­ç’°', 'CHW': 'æŸ´ç£', 'KET': 'å …å°¼åœ°åŸ',
                'TIK': 'èª¿æ™¯å¶º', 'WHA': 'é»ƒåŸ”', 'POA': 'å¯¶ç³', 'LOH': 'åº·åŸ',
                'NOP': 'åŒ—è§’', 'LOW': 'ç¾…æ¹–', 'LMC': 'è½é¦¬æ´²', 'HUH': 'ç´…ç£¡',
                'SHS': 'ä¸Šæ°´', 'ADM': 'é‡‘é˜', 'TUM': 'å±¯é–€', 'WKS': 'çƒæºªæ²™',
                'TUC': 'æ±æ¶Œ', 'HOK': 'é¦™æ¸¯', 'AIR': 'æ©Ÿå ´', 'AWE': 'åšè¦½é¤¨',
                'DIS': 'è¿ªå£«å°¼', 'SOH': 'æµ·æ€¡åŠå³¶', 'OCP': 'æµ·æ´‹å…¬åœ’', 
                'WCH': 'é»ƒç«¹å‘', 'LET': 'åˆ©æ±', 'EXC': 'æœƒå±•',
                'KOB': 'ä¹é¾ç£', 'TST': 'å°–æ²™å’€', 'MOK': 'æ—ºè§’', 'YMT': 'æ²¹éº»åœ°',
                'HKU': 'é¦™æ¸¯å¤§å­¸', 'SYP': 'è¥¿ç‡Ÿç›¤', 'SHW': 'ä¸Šç’°', 'TIH': 'å¤©å',
                'FOH': 'ç‚®å°å±±', 'TAK': 'å¤ªå¤', 'SWN': 'è¥¿ç£æ²³', 'SKW': 'ç­²ç®•ç£',
                'HFC': 'æèŠ±é‚¨', 'HOM': 'ä½•æ–‡ç”°', 'SKM': 'çŸ³ç¡¤å°¾', 'LOF': 'æ¨‚å¯Œ',
                'WTS': 'é»ƒå¤§ä»™', 'CHH': 'å½©è™¹', 'NTK': 'ç‰›é ­è§’', 'LAT': 'è—ç”°',
                'JOR': 'ä½æ•¦', 'SSP': 'æ·±æ°´åŸ—', 'CSW': 'é•·æ²™ç£', 'LCK': 'è”æè§’',
                'LAK': 'è”æ™¯', 'KWF': 'è‘µèŠ³', 'KWH': 'è‘µèˆˆ', 'TWH': 'å¤§çª©å£',
                'HAK': 'å‘å£', 'QUB': 'é°‚é­šæ¶Œ', 'YAT': 'æ²¹å¡˜', 'KOT': 'ä¹é¾å¡˜',
                'MKE': 'æ—ºè§’æ±', 'FOT': 'ç«ç‚­', 'RAC': 'é¦¬å ´', 'UNI': 'å¤§å­¸',
                'TAP': 'å¤§åŸ”å¢Ÿ', 'TWO': 'å¤ªå’Œ', 'FAN': 'ç²‰å¶º', 'MOS': 'é¦¬éå±±',
                'HEO': 'æ†å®‰', 'TSH': 'å¤§æ°´å‘', 'SHM': 'çŸ³é–€', 'CIO': 'ç¬¬ä¸€åŸ',
                'STW': 'æ²™ç”°åœ', 'CKT': 'è»Šå…¬å»Ÿ', 'HIK': 'é¡¯å¾‘', 'KAT': 'å•Ÿå¾·',
                'SWT': 'å®‹çš‡è‡º', 'TKW': 'åœŸç“œç£', 'ETS': 'å°–æ±', 'AUS': 'æŸ¯å£«ç”¸',
                'NAC': 'å—æ˜Œ', 'TWW': 'èƒç£è¥¿', 'KSR': 'éŒ¦ä¸Šè·¯', 'YUL': 'å…ƒæœ—',
                'LGP': 'æœ—å±', 'OLY': 'å¥§é‹', 'TSY': 'é’è¡£', 'SUN': 'æ¬£æ¾³',
                'TAW': 'å¤§åœ', 'SHT': 'æ²™ç”°', 'MEF': 'ç¾å­š', 'PRE': 'å¤ªå­',
                'CAB': 'éŠ…é‘¼ç£', 'WAC': 'ç£ä»”', 'KWT': 'è§€å¡˜', 'TKO': 'å°‡è»æ¾³',
                'DIH': 'é‘½çŸ³å±±', 'KOW': 'ä¹é¾'
            };
            return names[code] || code;
        }

        // Update the last updated time in the footer
        function updateFooterTime() {
            const timeElement = document.getElementById('lastUpdatedTime');
            if (timeElement) {
                timeElement.textContent = new Date().toLocaleTimeString('zh-HK', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        }
        
        // æŒ‰Enteréµæœå°‹
        document.getElementById('stationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('suggestions').style.display = 'none';
                searchStation();
            }
        });
        
        // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰å»ºè­°
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.input-container')) {
                document.getElementById('suggestions').style.display = 'none';
            }
        });
        
        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºæœ€è¿‘æœå°‹
        window.onload = function() {
            loadRecentStations();
            
            // Auto-focus on input for better UX
            document.getElementById('stationInput').focus();
        };

        // Add keyboard navigation for suggestions
        document.getElementById('stationInput').addEventListener('keydown', function(e) {
            const suggestions = document.getElementById('suggestions');
            const items = suggestions.querySelectorAll('.suggestion-item');
            
            if (suggestions.style.display === 'none' || items.length === 0) return;
            
            let selectedIndex = -1;
            items.forEach((item, index) => {
                if (item.classList.contains('selected')) {
                    selectedIndex = index;
                    item.classList.remove('selected');
                }
            });
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                items[selectedIndex].classList.add('selected');
                items[selectedIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, 0);
                items[selectedIndex].classList.add('selected');
                items[selectedIndex].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter' && selectedIndex >= 0) {
                e.preventDefault();
                items[selectedIndex].click();
            } else if (e.key === 'Escape') {
                suggestions.style.display = 'none';
            }
        });
    </script>
</body>
</html>
